
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‚ ì†Œë¹„ ê¸°ë¡ ë³´ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="calculator.css">
  <style>
    .record { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .record h4 { margin: 0 0 8px; }
    .record table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .record th, .record td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    .summary { margin-top: 10px; font-weight: bold; color: #333; }
    .deficit { color: #d00; }
    .surplus { color: #0071e3; }
  </style>
</head>
<body>
  <main>
    <h2>ğŸ“‚ ì›”ë³„ ì†Œë¹„ ê¸°ë¡ ë³´ê¸°</h2>
    <div id="historyList">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    <button onclick="location.href='calculator.html'">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </main>

  <script>
    const historyList = document.getElementById("historyList");

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString("ko-KR", { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function loadRecords() {
      const raw = localStorage.getItem("calculatorData");
      if (!raw) {
        historyList.innerHTML = "<p>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      let data = {};
      try {
        data = JSON.parse(raw);
      } catch {
        historyList.innerHTML = "<p>ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
        return;
      }

      const fixedRaw = localStorage.getItem("fixedExpenses");
      let fixed = [];
      try {
        fixed = JSON.parse(fixedRaw || "[]");
      } catch { fixed = []; }

      const budgetRaw = localStorage.getItem("budgets");
      let budgets = {};
      try {
        budgets = JSON.parse(budgetRaw || "{}");
      } catch { budgets = {}; }

      const months = Object.keys(data).sort().reverse();
      if (months.length === 0) {
        historyList.innerHTML = "<p>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      historyList.innerHTML = "";
      for (const month of months) {
        const entries = data[month];
        const section = document.createElement("div");
        section.className = "record";
        section.innerHTML = `<h4>ğŸ“… ${month}</h4><table><thead><tr><th>ë‚ ì§œ</th><th>ë‚´ì—­</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê¸ˆì•¡</th></tr></thead><tbody></tbody></table>`;
        const tbody = section.querySelector("tbody");

        const categoryTotals = {};
        let totalSpent = 0;

        entries.forEach(item => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${formatDate(item.date)}</td><td>${item.name}</td><td>${item.category}</td><td>${parseInt(item.amount).toLocaleString()}ì›</td>`;
          tbody.appendChild(row);

          totalSpent += parseInt(item.amount);
          if (!categoryTotals[item.category]) categoryTotals[item.category] = 0;
          categoryTotals[item.category] += parseInt(item.amount);
        });

        // ê³ ì •ì§€ì¶œ í•©ì‚°
        let fixedTotal = fixed.reduce((sum, f) => sum + (parseInt(f.amount) || 0), 0);

        const summary = document.createElement("div");
        summary.className = "summary";
        summary.innerHTML = `<p>ì´ ì†Œë¹„ ê¸ˆì•¡ (ë³€ë™ + ê³ ì •): ${(totalSpent + fixedTotal).toLocaleString()}ì›</p>`;

        // ì˜ˆì‚° ëŒ€ë¹„ ë‚¨ì€ ê¸ˆì•¡ í‘œì‹œ
        const budgetLines = [];
        for (const category in budgets) {
          const spent = categoryTotals[category] || 0;
          const budget = parseInt(budgets[category]);
          const diff = budget - spent;
          const status = diff >= 0 ? "surplus" : "deficit";
          budgetLines.push(`<span class="${status}">[${category}] ì˜ˆì‚° ${budget.toLocaleString()}ì› - ì‚¬ìš© ${spent.toLocaleString()}ì› â†’ ${diff >= 0 ? "ë‚¨ìŒ" : "ì´ˆê³¼"} ${Math.abs(diff).toLocaleString()}ì›</span>`);
        }

        if (budgetLines.length > 0) {
          summary.innerHTML += "<p>" + budgetLines.join("<br>") + "</p>";
        }

        section.appendChild(summary);
        historyList.appendChild(section);
      }
    }

    loadRecords();
  </script>
</body>
</html>
