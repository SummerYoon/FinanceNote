
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>📂 소비 기록 보기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="calculator.css">
  <style>
    .record { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .record h4 { margin: 0 0 8px; }
    .record table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .record th, .record td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    .summary { margin-top: 10px; font-weight: bold; color: #333; }
    .deficit { color: #d00; }
    .surplus { color: #0071e3; }
  </style>
</head>
<body>
  <main>
    <h2>📂 월별 소비 기록 보기</h2>
    <div id="historyList">기록을 불러오는 중입니다...</div>
    <button onclick="location.href='calculator.html'">← 메인으로 돌아가기</button>
  </main>

  <script>
    const historyList = document.getElementById("historyList");

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString("ko-KR", { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function loadRecords() {
      const raw = localStorage.getItem("calculatorData");
      if (!raw) {
        historyList.innerHTML = "<p>기록이 없습니다.</p>";
        return;
      }

      let data = {};
      try {
        data = JSON.parse(raw);
      } catch {
        historyList.innerHTML = "<p>저장된 데이터를 불러오지 못했습니다.</p>";
        return;
      }

      const fixedRaw = localStorage.getItem("fixedExpenses");
      let fixed = [];
      try {
        fixed = JSON.parse(fixedRaw || "[]");
      } catch { fixed = []; }

      const budgetRaw = localStorage.getItem("budgets");
      let budgets = {};
      try {
        budgets = JSON.parse(budgetRaw || "{}");
      } catch { budgets = {}; }

      const months = Object.keys(data).sort().reverse();
      if (months.length === 0) {
        historyList.innerHTML = "<p>기록이 없습니다.</p>";
        return;
      }

      historyList.innerHTML = "";
      for (const month of months) {
        const entries = data[month];
        const section = document.createElement("div");
        section.className = "record";
        section.innerHTML = `<h4>📅 ${month}</h4><table><thead><tr><th>날짜</th><th>내역</th><th>카테고리</th><th>금액</th></tr></thead><tbody></tbody></table>`;
        const tbody = section.querySelector("tbody");

        const categoryTotals = {};
        let totalSpent = 0;

        entries.forEach(item => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${formatDate(item.date)}</td><td>${item.name}</td><td>${item.category}</td><td>${parseInt(item.amount).toLocaleString()}원</td>`;
          tbody.appendChild(row);

          totalSpent += parseInt(item.amount);
          if (!categoryTotals[item.category]) categoryTotals[item.category] = 0;
          categoryTotals[item.category] += parseInt(item.amount);
        });

        // 고정지출 합산
        let fixedTotal = fixed.reduce((sum, f) => sum + (parseInt(f.amount) || 0), 0);

        const summary = document.createElement("div");
        summary.className = "summary";
        summary.innerHTML = `<p>총 소비 금액 (변동 + 고정): ${(totalSpent + fixedTotal).toLocaleString()}원</p>`;

        // 예산 대비 남은 금액 표시
        const budgetLines = [];
        for (const category in budgets) {
          const spent = categoryTotals[category] || 0;
          const budget = parseInt(budgets[category]);
          const diff = budget - spent;
          const status = diff >= 0 ? "surplus" : "deficit";
          budgetLines.push(`<span class="${status}">[${category}] 예산 ${budget.toLocaleString()}원 - 사용 ${spent.toLocaleString()}원 → ${diff >= 0 ? "남음" : "초과"} ${Math.abs(diff).toLocaleString()}원</span>`);
        }

        if (budgetLines.length > 0) {
          summary.innerHTML += "<p>" + budgetLines.join("<br>") + "</p>";
        }

        section.appendChild(summary);
        historyList.appendChild(section);
      }
    }

    loadRecords();
  </script>
</body>
</html>
